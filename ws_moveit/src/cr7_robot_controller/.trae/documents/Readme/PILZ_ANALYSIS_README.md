# PILZ焊接路径分析工具

## 概述

`analyze_pilz_welding.py` 是一个专门用于分析CR7机器人使用PILZ工业规划器执行焊接路径的工具。

它可以：
- 分析焊接路径点的几何特性
- 检查路径是否为直线
- 分析PILZ规划器生成的轨迹
- 计算末端执行器的偏差
- 生成详细的分析图表和报告

## 功能特点

### 1. **焊接路径点分析**
- 检查路径点是否形成直线
- 计算路径直线性系数（1.0为完全直线）
- 分析路径长度和间距分布

### 2. **PILZ轨迹分析**
- 统计轨迹点数和执行时间
- 分析关节速度和加速度曲线
- 计算时间步长统计

### 3. **直线性检查**
- 对比实际路径与理想直线
- 计算各点的空间偏差
- 生成偏差分布统计

### 4. **图表生成**
- `pilz_welding_analysis.png` - 焊接路径和轨迹分析
- `pilz_linearity_check.png` - 直线性检查和偏差分析
- `pilz_welding_analysis_report.txt` - 文本分析报告

## 使用方法

### 基本用法

```bash
cd /home/xionggu/cx_moveit/ws_moveit/src/cr7_robot_controller/data
python3 analyze_pilz_welding.py
```

### 指定数据目录

```bash
python3 analyze_pilz_welding.py /path/to/data
```

## 所需数据文件

脚本会自动查找以下CSV文件（按时间戳从新到旧）：

1. **焊接路径点文件**：`pilz_welding_waypoints_YYYYMMDD_HHMMSS.csv`
   - 包含起点和终点坐标

2. **PILZ轨迹文件**：`pilz_LIN_trajectory_YYYYMMDD_HHMMSS.csv`
   - 包含关节位置、速度、加速度

3. **笛卡尔轨迹文件**（可选）：`original_trajectory_YYYYMMDD_HHMMSS.csv`
   - 用于与PILZ轨迹对比

## 输出文件

### 1. 图表文件

#### `pilz_welding_analysis.png`
包含6个子图：
- 左上: 3D焊接路径（期望）
- 中上: XY平面投影
- 右上: 路径点间距分布
- 左下: 轨迹点时间间隔
- 中下: 关节速度曲线
- 右下: 关节加速度曲线

#### `pilz_linearity_check.png`
包含6个子图：
- 左上: 3D轨迹直线性检查
- 中上: XY平面直线性检查  
- 右上: XZ平面直线性检查
- 左下: 总体偏差分布
- 中下: 各轴偏差对比
- 右下: 偏差直方图

### 2. 报告文件

`pilz_welding_analysis_report.txt` 包含：
- 焊接路径点信息
- PILZ轨迹信息
- 直线性分析统计
- 关节运动学特性

## 关键指标解释

### 直线性系数
- **1.0**: 完全直线
- **0.95-0.99**: 接近直线，存在轻微弯曲
- **<0.95**: 路径有明显弯曲

### 偏差统计
- **最大偏差**: 路径偏离理想直线的最大距离
- **平均偏差**: 所有点的平均偏离距离
- **标准差**: 偏差的波动程度

### 执行特性
- **轨迹点数**: PILZ规划器生成的点数越多，轨迹越光滑
- **执行时间**: 总体执行时间
- **时间步长**: 点之间的时间间隔（均匀性指示）

## 示例输出

```
============================================================
PILZ焊接路径分析工具
============================================================

============================================================
加载PILZ焊接路径数据
============================================================
✓ 已加载焊接路径点: pilz_welding_waypoints_20260128_120000.csv
  数据形状: (2, 8)
✓ 已加载PILZ LIN轨迹: pilz_LIN_trajectory_20260128_120005.csv
  数据形状: (150, 25)

============================================================
焊接路径点分析
============================================================
总路径点数: 2
总路径长度: 0.750000 m
起点: [0.977720, -0.374100, 0.028286]
终点: [0.977720, 0.377530, 0.028286]
直线距离: 0.751630 m
直线性系数: 1.0005 (1.0=完全直线)
✓ 路径是直线

============================================================
PILZ LIN轨迹分析
============================================================
轨迹点数: 150
轨迹总时间: 3.500 秒
...
```

## 故障排除

### 找不到数据文件？
确保在运行机器人控制程序时执行了PILZ焊接路径测试，这会生成所需的CSV文件。

### 图表无法显示中文？
脚本会自动搜索系统中的中文字体。如果找不到，图表仍然会生成但中文标签会显示为方块。

安装中文字体（可选）：
```bash
# Ubuntu/Debian
sudo apt-get install fonts-wqy-zenhei

# 之后重新运行脚本
```

### Python错误？
确保安装了必要的依赖：
```bash
pip3 install pandas numpy matplotlib
```

## 依赖项

- Python 3.6+
- pandas
- numpy
- matplotlib
- mpl_toolkits (matplotlib的一部分)

## 集成到工作流

### 1. 运行机器人控制程序
```bash
ros2 launch cr7_controller cr7_controller.launch.py
# 选择选项9 -> 6，执行PILZ焊接点位路径测试
```

### 2. 分析结果
```bash
cd data/
python3 analyze_pilz_welding.py
# 查看生成的png和txt文件
```

### 3. 查看图表
```bash
# 使用任何图片查看器打开
eog pilz_welding_analysis.png
eog pilz_linearity_check.png

# 或使用文本编辑器查看报告
cat pilz_welding_analysis_report.txt
```

## 常见问题

**Q: 为什么路径曲线是曲线而不是直线？**
A: PILZ LIN规划器会生成光滑的加速度曲线以实现工业级运动控制。在末端执行器空间中路径可能是直线，但在关节空间中则是曲线。

**Q: 直线性系数是1.0但偏差不是0？**
A: 这是正常的。直线性系数是基于沿路径的路径长度，而偏差是基于空间中相对于理想直线的位置。

**Q: 如何改进路径的直线性？**
A: 调整PILZ配置参数或增加路径点数量。参考PILZ规划器文档。

## 许可证

该工具是CR7机器人控制器的一部分。
